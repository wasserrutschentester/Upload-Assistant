name: Python Code Analysis

on:
  push:
    branches:
      - master
  pull_request:
    branches:
      - master
    types: [opened, synchronize, reopened]
  workflow_dispatch:

permissions:
  contents: read
  actions: write

jobs:
  code-analysis:
    if: github.event_name != 'pull_request' || github.event.pull_request.draft == false
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ['3.9', '3.10', '3.11', '3.12', '3.13', '3.14']

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        ref: ${{ github.event.pull_request.head.sha || github.sha }}

    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}

    - name: Cache pip dependencies
      uses: actions/cache@v4
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        # Install code analysis tools
        pip install pyright bandit pycodestyle autopep8 ruff==0.14.13

    - name: Create CI config.py
      run: |
        if [ ! -f "data/config.py" ] && [ -f "data/example-config.py" ]; then
          cp "data/example-config.py" "data/config.py"
        fi

    - name: Deprecation Warnings Scan
      continue-on-error: true
      run: |
        python - <<'PY'
        import os
        import re
        import warnings
        from pathlib import Path
        import importlib.util

        warnings.simplefilter('default', DeprecationWarning)
        warnings.simplefilter('default', PendingDeprecationWarning)

        captured = []

        def record_warning(message, category, filename, lineno, file=None, line=None):
            captured.append(f"{category.__name__}: {message} ({filename}:{lineno})")

        warnings.showwarning = record_warning

        exclude_dirs = {'.git', '__pycache__', '.pytest_cache', 'venv', '.venv', 'env', 'tmp', 'tests', 'bin'}
        roots = [Path('src'), Path('web_ui'), Path('cogs')]
        files = []

        for root in roots:
            if root.exists():
                for path in root.rglob('*.py'):
                    if not any(part in exclude_dirs for part in path.parts):
                        files.append(path)

        files.extend([p for p in Path('.').glob('*.py') if p.is_file()])

        def module_name_from_path(path: Path) -> str:
            sanitized = re.sub(r'[^a-zA-Z0-9_]', '_', path.as_posix())
            return f"deprecation_scan_{sanitized}"

        for path in sorted(set(files)):
            try:
                spec = importlib.util.spec_from_file_location(module_name_from_path(path), path)
                if spec and spec.loader:
                    module = importlib.util.module_from_spec(spec)
                    spec.loader.exec_module(module)
            except BaseException:
                # Ignore import/runtime errors during deprecation scanning
                continue

        output_path = os.environ.get('DEPRECATION_OUTPUT', 'deprecation-warnings.txt')
        with open(output_path, 'w', encoding='utf-8') as f:
            if captured:
                f.write('\n'.join(captured))
        PY
      env:
        DEPRECATION_OUTPUT: deprecation-warnings-${{ matrix.python-version }}.txt

    - name: Ruff Lint
      continue-on-error: true
      run: |
        echo "Ruff version:"
        ruff --version
        echo ""
        echo "Checking for pyproject.toml:"
        ls -la pyproject.toml
        echo ""
        echo "Contents of pyproject.toml:"
        cat pyproject.toml
        echo ""
        echo "Checking Ruff settings for a sample file:"
        ruff check src/uphelper.py --show-settings | grep -A 20 "isort" || echo "No isort settings found"
        echo ""
        echo "Sample file imports (src/uphelper.py lines 1-16):"
        head -n 16 src/uphelper.py
        echo ""
        echo "Running ruff check:"
        ruff check --config pyproject.toml . > ruff-results-${{ matrix.python-version }}.txt 2>&1 || true
        echo ""
        echo "Ruff results:"
        cat ruff-results-${{ matrix.python-version }}.txt
        echo ""
        echo "Exit code handling: Step will continue regardless of errors"

    - name: Upload Deprecation Warnings
      if: github.event_name == 'pull_request'
      uses: actions/upload-artifact@v4
      with:
        name: deprecation-warnings-${{ matrix.python-version }}
        path: deprecation-warnings-${{ matrix.python-version }}.txt

    - name: Upload Ruff Results
      if: github.event_name == 'pull_request'
      uses: actions/upload-artifact@v4
      with:
        name: ruff-results-${{ matrix.python-version }}
        path: ruff-results-${{ matrix.python-version }}.txt

    - name: Type Checking with Pyright
      continue-on-error: true
      run: |
        echo "Running type checking for Python ${{ matrix.python-version }}..."
        # Override pythonVersion in Pyright to match the matrix version
        pyright --pythonversion ${{ matrix.python-version }} . > pyright-results-${{ matrix.python-version }}.txt 2>&1 || echo "Pyright scan completed with results saved"
        
        # Display results
        cat pyright-results-${{ matrix.python-version }}.txt

    - name: Upload Pyright Results
      if: github.event_name == 'pull_request'
      uses: actions/upload-artifact@v4
      with:
        name: pyright-results-${{ matrix.python-version }}
        path: pyright-results-${{ matrix.python-version }}.txt

    - name: Security Analysis with Bandit
      continue-on-error: true
      run: |
        echo "Running security analysis with configuration file..."
        echo ""
        echo "ðŸ”’ SECURITY NOTE: tmp directory security is handled at application level:"
        echo "   âœ… tmp directories created with 0o700 permissions (owner-only access)"
        echo "   âœ… Implemented in upload.py do_the_thing() function"
        echo "   âœ… Bandit B108 warnings suppressed via bandit.yaml config file"
        echo ""
        echo "ðŸ“Š Using bandit.yaml configuration file to skip resolved security issues"
        
        # Check if bandit.yaml config file exists and use it
        if [ -f "bandit.yaml" ]; then
          echo "âœ… Found bandit.yaml configuration file"
          cat bandit.yaml
          echo ""
          echo "Running bandit with YAML configuration..."
          bandit -r . -f txt -c bandit.yaml > bandit-results-${{ matrix.python-version }}.txt 2>&1 || echo "Bandit scan completed with configuration"
        elif [ -f ".bandit" ]; then
          echo "âœ… Found legacy .bandit configuration file"
          cat .bandit
          echo ""
          echo "Running bandit with legacy configuration..."
          bandit -r . -f txt -c .bandit > bandit-results-${{ matrix.python-version }}.txt 2>&1 || echo "Bandit scan completed with configuration"
        else
          echo "âš ï¸  No bandit config file found, running with basic exclusions"
          bandit -r . -f txt --exclude ./tmp,./venv,./.venv,./env,./.git,./__pycache__ > bandit-results-${{ matrix.python-version }}.txt 2>&1 || echo "Bandit scan completed"
        fi
        
        # Display results
        cat bandit-results-${{ matrix.python-version }}.txt

    - name: Upload Bandit Results
      if: github.event_name == 'pull_request'
      uses: actions/upload-artifact@v4
      with:
        name: bandit-results-${{ matrix.python-version }}
        path: bandit-results-${{ matrix.python-version }}.txt

    - name: Dependency Security Check with Safety
      continue-on-error: true
      run: |
        echo "Running dependency security check with Safety..."
        pip install "safety==2.3.5"
        safety check -r requirements.txt --full-report > safety-results-${{ matrix.python-version }}.txt 2>&1 || echo "Safety scan completed with results saved"
        
        # Display results
        cat safety-results-${{ matrix.python-version }}.txt

    - name: Upload Safety Results
      if: github.event_name == 'pull_request'
      uses: actions/upload-artifact@v4
      with:
        name: safety-results-${{ matrix.python-version }}
        path: safety-results-${{ matrix.python-version }}.txt

  summary:
    runs-on: ubuntu-latest
    needs: code-analysis
    if: always()
    
    steps:
    - name: Analysis Summary
      run: |
        echo "Python Code Analysis Summary:"
        echo "âœ… Ruff lint completed"
        echo "âœ… Deprecation warnings scan completed"
        echo "âœ… Type checking completed"
        echo "âœ… Security analysis with Bandit completed"
        echo "âœ… Dependency security check with Safety completed"
        echo ""
        echo "Check the job logs above for detailed results."
